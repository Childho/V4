# 限时秒杀页面 API 集成说明

**状态：✅ API集成已完成**

## 更新概览

限时秒杀页面(`/pages/seckill/index.js`)已完成静态数据向真实API的转换，严格按照接口文档(`/api-docs/seckill.md`)进行字段映射。

## 主要变更

### 1. API模块创建
新建 `seckillApi.js` 包含秒杀相关接口：
```javascript
import { getSeckillProducts, seckillBuyNow, getCartCount } from '../../api/seckillApi.js';
```

### 2. 核心方法改造

#### loadSeckillData() - 秒杀数据加载
- **接口**：`/api/seckill/products` (GET)
- **功能**：获取秒杀商品列表、品牌数据、购物车数量
- **参数映射**：`{ page, pageSize, brand, keyword }`
- **响应处理**：解析`body.products`、`body.defaultBrands`、`body.extraBrands`、`body.cartCount`
- **错误处理**：API失败时显示重试对话框并提供默认数据降级

#### processSeckillBuy() - 秒杀购买处理
- **接口**：`/api/seckill/buy-now` (POST)
- **功能**：执行秒杀购买操作
- **参数映射**：`{ productId, quantity }`
- **响应处理**：解析`body.success`、`body.message`、`body.orderId`、`body.remainingStock`
- **错误处理**：区分不同错误类型（库存不足、重复购买、秒杀结束、未登录等）并提供相应提示

#### updateCartCount() - 购物车数量更新
- **接口**：`/api/cart/count` (GET)
- **功能**：获取用户购物车商品总数量
- **响应处理**：解析`body.cartCount`
- **降级策略**：API失败时使用本地缓存数据

### 3. 数据结构映射

#### 秒杀商品请求结构
```javascript
{
  page: 1,                    // 页码（可选，默认1）
  pageSize: 20,               // 每页数量（可选，默认20）
  brand: "lining",            // 品牌筛选（可选，all全部）
  keyword: "羽毛球拍"         // 搜索关键词（可选）
}
```

#### 秒杀商品响应结构
```javascript
{
  "error": 0,
  "body": {
    "products": [...],        // 商品列表
    "defaultBrands": [...],   // 默认显示品牌
    "extraBrands": [...],     // 额外品牌
    "cartCount": 5            // 购物车数量
  },
  "message": "获取秒杀商品列表成功",
  "success": true
}
```

#### 商品数据字段映射
- `id`: 商品ID
- `brand`: 品牌名称
- `brandKey`: 品牌标识
- `title`: 商品标题
- `imageUrl`: 商品主图
- `seckillPrice`: 秒杀价格（字符串格式）
- `originalPrice`: 原价（字符串格式）
- `stock`: 剩余库存
- `soldCount`: 已售数量
- `endTime`: 秒杀结束时间
- `countdownText`: 倒计时文字
- `tags`: 商品标签数组

#### 秒杀购买请求结构
```javascript
{
  productId: 1,               // 商品ID
  quantity: 1                 // 购买数量（通常为1）
}
```

#### 秒杀购买响应结构
```javascript
{
  "error": 0,
  "body": {
    "success": true,
    "message": "购买成功！",
    "orderId": "ORDER_SK_001",
    "productInfo": {...},
    "remainingStock": 149
  },
  "message": "秒杀购买成功",
  "success": true
}
```

### 4. 用户交互优化

#### 秒杀流程
1. **确认购买**：显示商品信息和秒杀价格的确认对话框
2. **执行购买**：调用秒杀API，显示"正在抢购..."加载状态
3. **结果处理**：
   - 成功：显示订单号，更新库存和购物车数量
   - 失败：根据错误类型显示相应提示，提供重试选项

#### 错误处理策略
- **库存不足**：提示"商品已被抢完，下次要更快哦！"
- **重复购买**：提示"您已购买过此商品，每人限购1件"
- **秒杀结束**：提示"秒杀活动已结束"
- **未登录**：提示"请先登录再进行秒杀"
- **其他错误**：显示具体错误信息并提供重试选项

#### 状态管理
- `isLoading`: 页面数据加载状态
- 购买过程中的loading状态管理
- 实时库存更新和同步

### 5. 筛选和搜索功能

#### 品牌筛选
- **默认品牌**：倍特爱、李宁、威克多、超牌
- **额外品牌**：翎美、亚狮龙、威肯、泰昂
- **筛选逻辑**：选择品牌时重新调用API获取筛选后的商品

#### 关键词搜索
- **搜索范围**：商品标题、品牌名称
- **搜索触发**：输入关键词后点击确认或回车
- **搜索逻辑**：重新调用API进行服务端搜索

#### 实时筛选
- 品牌和关键词变更时自动重新加载数据
- 保证数据的实时性和准确性

### 6. 倒计时功能

#### 倒计时处理
- 使用服务端返回的`endTime`和`countdownText`
- 本地定时器每秒更新倒计时显示
- 倒计时结束时自动设置库存为0

#### 时间同步
- 服务端计算倒计时，避免客户端时间不准确
- 本地仅负责显示更新，不影响业务逻辑

### 7. 性能优化

#### API调用优化
- 智能筛选：只在必要时重新调用API
- 错误恢复：API失败时提供降级数据
- 缓存策略：购物车数量支持本地缓存降级

#### 用户体验优化
- 加载状态：明确的loading提示
- 操作反馈：购买过程的详细状态提示
- 错误恢复：友好的错误信息和重试机制

## 接口对应关系

| 功能 | 接口地址 | 请求方式 | 状态 |
|-----|---------|---------|-----|
| 秒杀商品列表 | `/api/seckill/products` | GET | ✅ 已集成 |
| 秒杀立即购买 | `/api/seckill/buy-now` | POST | ✅ 已集成 |
| 购物车数量 | `/api/cart/count` | GET | ✅ 已集成 |

## 页面跳转

### 商品详情跳转
- **目标页面**：`/pages/productDetail/index`
- **参数传递**：`?id=${productId}&from=seckill`
- **触发方式**：点击商品卡片

### 购物车跳转
- **目标页面**：`/pages/cart/cart`
- **触发方式**：点击悬浮购物车按钮

## 移除的功能

1. **generateMockProducts()方法**：移除静态商品数据生成
2. **getRandomTags()方法**：移除随机标签生成
3. **generateRandomEndTime工具类使用**：改为使用服务端时间
4. **静态品牌数据**：移除硬编码的品牌数组
5. **本地筛选逻辑**：改为服务端筛选

## 兼容性保证

- 保持原有页面数据结构和字段名不变
- 保持与WXML模板的完整兼容性
- 品牌筛选和搜索功能的交互体验保持不变
- 倒计时显示逻辑保持一致

## URL参数支持

### 品牌筛选
- **参数**：`brand`
- **支持值**：`beta`, `lining`, `victor`, `super`, `lingmei`, `yashilong`, `weiken`, `taiang`

### 搜索关键词
- **参数**：`keyword`
- **处理**：页面加载时自动填入搜索框并执行搜索

## 业务规则实现

### 秒杀规则
- **限购数量**：每个用户每个商品限购1件（服务端验证）
- **库存管理**：实时库存扣减，防止超卖
- **倒计时管理**：服务端计算，客户端显示
- **重复购买检查**：服务端验证，前端提示

### 防刷保护
- 购买操作防重复提交
- 服务端限制同一用户操作频率
- 网络异常时的重试机制

## 数据流程

### 页面初始化流程
1. 解析URL参数（品牌、关键词）
2. 调用秒杀商品API获取数据
3. 启动倒计时定时器
4. 更新购物车数量

### 秒杀购买流程
1. 用户点击"抢"按钮
2. 显示确认购买对话框
3. 调用秒杀购买API
4. 处理购买结果
5. 更新页面状态

### 筛选搜索流程
1. 用户选择品牌或输入关键词
2. 重新调用API获取筛选结果
3. 更新商品列表显示

## 开发者注意事项

1. 所有API调用都包含详细的console.log，便于调试
2. 错误信息对用户友好，对开发者详细
3. 字段映射严格按照接口文档执行
4. 支持完整的错误恢复机制
5. 遵循小程序异步编程最佳实践

## 测试建议

1. 测试不同品牌的筛选功能
2. 测试关键词搜索的准确性
3. 测试秒杀购买的各种场景
4. 测试网络异常时的错误处理
5. 测试倒计时的准确性
6. 测试库存更新的实时性
7. 测试购物车数量的同步
8. 测试下拉刷新功能

## 错误码处理

根据接口文档，处理以下错误码：
- `0`: 成功
- `401`: 未登录
- `400`: 参数错误
- `409`: 库存不足
- `410`: 秒杀结束
- `429`: 操作频繁
- `5000`: 服务器内部错误

## 性能指标

### API性能
- 秒杀商品列表：支持分页，减少数据传输量
- 购买操作：快速响应，减少用户等待时间
- 缓存策略：购物车数量支持本地缓存

### 用户体验
- 实时数据：库存、价格、倒计时都是实时更新
- 友好反馈：清晰的操作状态和结果提示
- 错误恢复：完善的重试和降级机制

现在限时秒杀页面已经完全集成了真实API，可以进行真实的秒杀购买、动态库存管理、实时倒计时，为用户提供完整的秒杀购物体验！