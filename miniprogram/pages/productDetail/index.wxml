<view class="product-detail-container">
  <!-- å•†å“è½®æ’­å›¾ -->
  <swiper class="product-swiper" indicator-dots="{{true}}" autoplay="{{true}}" interval="{{3000}}" duration="{{500}}" circular="{{true}}">
    <swiper-item wx:for="{{product.images}}" wx:key="index">
      <image class="product-image" src="{{item}}" mode="aspectFill" lazy-load />
    </swiper-item>
  </swiper>
  
  <!-- å•†å“åŸºæœ¬ä¿¡æ¯åŒºåŸŸ -->
  <view class="product-info">
    <!-- ä»·æ ¼å’Œé”€é‡ -->
    <view class="price-section">
      <view class="current-price">Â¥{{product.price}}</view>
      <view class="original-price" wx:if="{{product.originalPrice}}">Â¥{{product.originalPrice}}</view>
      <view class="sales-info">å·²å”®{{product.salesCount}}ä»¶</view>
    </view>
    
    <!-- å•†å“æ ‡é¢˜å’Œæè¿° -->
    <view class="product-title">{{product.name}}</view>
    <view class="product-subtitle">{{product.description}}</view>
    
    <!-- æœåŠ¡ä¿éšœæ ‡ç­¾ -->
    <view class="service-tags">
      <view class="service-tag">
        <image class="service-icon" src="/assets/icons/shipping.png" mode="aspectFit" />
        <text>{{product.shippingInfo || '24å°æ—¶å‘è´§'}}</text>
      </view>
      <view class="service-tag">
        <image class="service-icon" src="/assets/icons/return.png" mode="aspectFit" />
        <text>7å¤©æ— ç†ç”±é€€æ¢</text>
      </view>
      <view class="service-tag">
        <image class="service-icon" src="/assets/icons/authentic.png" mode="aspectFit" />
        <text>æ­£å“ä¿éšœ</text>
      </view>
    </view>
    
    <!-- å“ç‰Œå’Œè§„æ ¼é€‰æ‹© -->
    <view class="product-meta">
      <view class="brand-info" wx:if="{{product.brand}}">
        <text class="label">å“ç‰Œï¼š</text>
        <text class="value">{{product.brand}}</text>
      </view>
      <view class="specs-selector" bindtap="showSpecsPopup">
        <text class="label">è§„æ ¼ï¼š</text>
        <text class="value">{{selectedSpecs || 'è¯·é€‰æ‹©è§„æ ¼'}}</text>
        <image class="arrow-right" src="/assets/icons/arrow_right.png" mode="aspectFit" />
      </view>
    </view>
  </view>

  <!-- å•†å“è¯„è®ºåŒºåŸŸ -->
  <view class="comments-section">
    <view class="section-header">
      <view class="section-title">å•†å“è¯„ä»· ({{comments.total || 0}})</view>
      <view class="view-all" bindtap="navigateToComments" wx:if="{{comments.total > 0}}">
        æŸ¥çœ‹å…¨éƒ¨
        <image class="arrow-icon" src="/assets/icons/arrow_right.png" mode="aspectFit" />
      </view>
    </view>
    
    <!-- è¯„ä»·æ¦‚è§ˆ -->
    <view class="comment-overview" wx:if="{{comments.total > 0}}">
      <view class="rating-score">
        <view class="stars">
          <image class="star-icon" wx:for="{{5}}" wx:key="index" 
                 src="{{index < Math.floor(comments.averageRating) ? '/assets/icons/star_filled.png' : '/assets/icons/star_empty.png'}}" 
                 mode="aspectFit" />
        </view>
      </view>
      <view class="rating-tags">
        <text class="tag" wx:for="{{comments.tags}}" wx:key="index">{{item}}</text>
      </view>
    </view>
    
    <!-- è¯„è®ºåˆ—è¡¨é¢„è§ˆ -->
    <view class="comment-preview" wx:if="{{comments.list.length > 0}}">
      <view class="comment-item" wx:for="{{comments.list}}" wx:key="id" wx:for-index="idx" wx:if="{{idx < 2}}">
        <view class="comment-header">
          <image class="user-avatar" src="{{item.userAvatar || '/assets/icons/default_avatar.png'}}" mode="aspectFill" />
          <view class="user-info">
            <text class="username">{{item.username}}</text>
            <view class="comment-rating">
              <image class="star-icon" wx:for="{{5}}" wx:key="ratingIndex" wx:for-index="ratingIndex"
                     src="{{ratingIndex < item.rating ? '/assets/icons/star_filled.png' : '/assets/icons/star_empty.png'}}" 
                     mode="aspectFit" />
            </view>
          </view>
          <text class="comment-date">{{item.createTime}}</text>
        </view>
        <text class="comment-content">{{item.content}}</text>
        <view class="comment-images" wx:if="{{item.images && item.images.length > 0}}">
          <image wx:for="{{item.images}}" wx:key="imgIndex" wx:for-item="imgItem"
                 src="{{imgItem}}" mode="aspectFill" class="comment-img" />
        </view>
      </view>
    </view>
    
    <!-- æ— è¯„è®ºæç¤º -->
    <view class="no-comments" wx:if="{{comments.total === 0}}">
      <image class="empty-icon" src="/assets/icons/no_comment.png" mode="aspectFit" />
      <text class="empty-text">æš‚æ— è¯„ä»·ï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</text>
    </view>
  </view>

  <!-- ç›¸å…³æ¨è -->
  <view class="related-products" wx:if="{{relatedProducts.length > 0}}">
    <view class="section-title">ç›¸å…³æ¨è</view>
    <scroll-view scroll-x="true" class="related-scroll" show-scrollbar="{{false}}">
      <view class="related-list">
        <view class="related-item" wx:for="{{relatedProducts}}" wx:key="id" bindtap="navigateToProduct" data-id="{{item.id}}">
          <image class="related-image" src="{{item.imageUrl}}" mode="aspectFill" lazy-load />
          <view class="related-name">{{item.name}}</view>
          <view class="related-price">Â¥{{item.price}}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å•†å“è§„æ ¼å‚æ•° -->
  <view class="product-specs">
    <view class="section-title">è§„æ ¼å‚æ•°</view>
    <view class="specs-list">
      <view class="specs-item" wx:for="{{product.specs}}" wx:key="name">
        <text class="specs-label">{{item.name}}</text>
        <text class="specs-value">{{item.value}}</text>
      </view>
    </view>
  </view>

  <!-- å•†å“è¯¦æƒ…å›¾æ–‡ -->
  <view class="product-detail">
    <view class="section-title">å›¾æ–‡è¯¦æƒ…</view>
    <view class="detail-content">
      <rich-text nodes="{{product.detailContent}}"></rich-text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar">
    <!-- å·¦ä¾§åŠŸèƒ½åŒº -->
    <view class="left-actions">
      <!-- å®¢æœ -->
      <button class="action-btn" open-type="contact" show-message-card="{{true}}">
        <image class="action-icon" src="/assets/icons/service.svg" mode="aspectFit" />
        <text class="action-text">å®¢æœ</text>
      </button>
      
      <!-- è´­ç‰©è½¦ -->
      <view class="action-btn cart-btn" bindtap="handleToCart">
        <image class="action-icon" src="/assets/icons/cart.svg" mode="aspectFit" />
        <text class="action-text">è´­ç‰©è½¦</text>
        <view class="cart-badge" wx:if="{{cartCount > 0}}">{{cartCount > 99 ? '99+' : cartCount}}</view>
      </view>
    </view>
    
    <!-- å³ä¾§è´­ä¹°æŒ‰é’®åŒº -->
    <view class="right-actions">
      <button class="add-cart-btn" bindtap="handleAddToCart">
        <image class="cart-icon" src="/assets/icons/cart.svg" mode="aspectFit" />
        åŠ å…¥è´­ç‰©è½¦
      </button>
      <button class="buy-now-btn" bindtap="handleBuyNow">ç«‹å³è´­ä¹°</button>
    </view>
  </view>

  <!-- è§„æ ¼é€‰æ‹©å¼¹çª— -->
  <view class="specs-popup" wx:if="{{showSpecsPopup}}">
    <view class="popup-mask" bindtap="closeSpecsPopup"></view>
    <view class="popup-content">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="popup-header">
        <image class="popup-product-image" src="{{product.images[0]}}" mode="aspectFill" />
        <view class="popup-product-info">
          <view class="popup-product-price">Â¥{{product.price}}</view>
          <view class="popup-product-name">{{product.name}}</view>
          <view class="popup-selected-specs">å·²é€‰ï¼š{{selectedSpecs || 'è¯·é€‰æ‹©è§„æ ¼'}}</view>
        </view>
        <view class="popup-close" bindtap="closeSpecsPopup">Ã—</view>
      </view>

      <!-- åœ°å€é€‰æ‹©æ¨¡å—ï¼ˆä»…ç«‹å³è´­ä¹°æ—¶æ˜¾ç¤ºï¼Œæ”¾åœ¨å¼¹çª—æœ€ä¸Šæ–¹ï¼‰ -->
      <view class="popup-address-section" wx:if="{{currentAction === 'buy'}}" bindtap="navigateToAddress">
        <view class="popup-address-container">
          <view class="popup-address-content">
            <view wx:if="{{defaultAddress}}" class="popup-address-info">
              <view class="popup-consignee-line">
                <text class="popup-consignee-name">{{defaultAddress.consignee}}</text>
                <text class="popup-consignee-mobile">{{defaultAddress.mobile}}</text>
              </view>
              <view class="popup-address-line">
                <text class="popup-address-detail">{{defaultAddress.province}}{{defaultAddress.city}}{{defaultAddress.district}}{{defaultAddress.detail}}</text>
              </view>
            </view>
            <view wx:else class="popup-no-address-info">
              <text class="popup-add-address-text">è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
              <text class="popup-add-address-tip">é€‰æ‹©åå¯æŸ¥çœ‹é…é€ä¿¡æ¯å’Œè¿è´¹</text>
            </view>
          </view>
          <view class="popup-address-action">
            <view class="popup-shipping-info">
              <text class="popup-shipping-fee">{{shippingFee}}</text>
            </view>
            <image class="arrow-right" src="/assets/icons/arrow_right.png" mode="aspectFit" />
          </view>
        </view>
      </view>

      <!-- å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
      <view class="popup-scrollable-content">
        <!-- æ•°é‡é€‰æ‹© -->
        <view class="popup-quantity">
          <view class="popup-quantity-title">æ•°é‡</view>
          <view class="popup-quantity-control">
            <view class="quantity-minus {{quantity <= 1 ? 'disabled' : ''}}" bindtap="decreaseQuantity">-</view>
            <input class="quantity-input" type="number" value="{{quantity}}" disabled />
            <view class="quantity-plus" bindtap="increaseQuantity">+</view>
          </view>
        </view>

        <!-- è§„æ ¼é€‰æ‹© -->
        <view class="popup-specs">
          <view class="popup-specs-item" wx:for="{{product.optionGroups}}" wx:key="name">
            <view class="popup-specs-title">{{item.name}}</view>
            <view class="popup-specs-options">
              <view 
                class="popup-specs-option {{optionItem.selected ? 'selected' : ''}} {{optionItem.disabled ? 'disabled' : ''}}" 
                wx:for="{{item.options}}" 
                wx:for-item="optionItem"
                wx:key="value"
                bindtap="selectOption"
                data-group-index="{{index}}"
                data-option-index="{{optionIndex}}"
                wx:for-index="optionIndex"
              >
                {{optionItem.value}}
              </view>
            </view>
          </view>
        </view>
        
        <!-- ä¼˜æƒ åˆ¸é€‰æ‹©ï¼ˆä»…ç«‹å³è´­ä¹°æ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="popup-coupon-section" wx:if="{{currentAction === 'buy'}}">
          <view class="popup-coupon-title">
            <text>ä¼˜æƒ åˆ¸</text>
            <text class="coupon-count">{{availableCouponCount > 0 ? 'æœ‰' + availableCouponCount + 'å¼ å¯ç”¨' : 'æš‚æ— å¯ç”¨'}}</text>
          </view>
          <view class="popup-coupon-selector" bindtap="handleSelectCoupon">
            <view class="coupon-selected-info">
              <view wx:if="{{selectedCoupon}}" class="coupon-info">
                <text class="coupon-name">{{selectedCoupon.title}}</text>
                <text class="coupon-discount">-Â¥{{selectedCoupon.amount}}</text>
              </view>
              <text wx:else class="coupon-placeholder">é€‰æ‹©ä¼˜æƒ åˆ¸</text>
            </view>
            <image class="arrow-right" src="/assets/icons/arrow_right.png" mode="aspectFit" />
          </view>
        </view>
        
        <!-- å¤‡æ³¨è¾“å…¥ï¼ˆä»…ç«‹å³è´­ä¹°æ—¶æ˜¾ç¤ºï¼ŒåŠ å…¥è´­ç‰©è½¦æ—¶éšè—ï¼‰ -->
        <view class="popup-remark" wx:if="{{currentAction === 'buy'}}">
          <view class="popup-remark-title">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</view>
          <textarea 
            class="popup-remark-input" 
            placeholder="æ‚¨å¯ä»¥åœ¨æ­¤å¡«å†™ç‰¹æ®Šè¦æ±‚æˆ–å¤‡æ³¨ä¿¡æ¯"
            value="{{orderRemark}}"
            bindinput="onRemarkInput"
            maxlength="100"
            show-confirm-bar="{{false}}"
            auto-height
          ></textarea>
          <view class="remark-counter">{{orderRemark.length || 0}}/100</view>
        </view>
        
        <!-- å‘ç¥¨æœåŠ¡æç¤ºï¼ˆä»…ç«‹å³è´­ä¹°æ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="popup-invoice-tip" wx:if="{{currentAction === 'buy'}}">
          <view class="invoice-icon">ğŸ“„</view>
          <view class="invoice-text">
            <text class="invoice-title">éœ€è¦å‘ç¥¨ï¼Ÿ</text>
            <text class="invoice-desc">è¯·è”ç³»å®¢æœå¼€å…·å‘ç¥¨</text>
          </view>
          <button class="invoice-contact-btn" open-type="contact" show-message-card="{{true}}">
            è”ç³»å®¢æœ
          </button>
        </view>
      </view>
      
      <!-- ç¡®è®¤æŒ‰é’® -->
      <view class="popup-btns">
        <button class="popup-add-cart-btn" bindtap="confirmAddToCart" wx:if="{{currentAction === 'cart'}}">
          åŠ å…¥è´­ç‰©è½¦
        </button>
        <button class="popup-buy-now-btn" bindtap="confirmBuyNow" wx:if="{{currentAction === 'buy'}}">
          ç«‹å³è´­ä¹°
        </button>
      </view>
    </view>
  </view>
  
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view class="loading-mask" wx:if="{{loading}}">
    <view class="loading-content">
      <image class="loading-image" src="/assets/icons/loading.gif" mode="aspectFit" />
      <text class="loading-text">å•†å“ä¿¡æ¯åŠ è½½ä¸­...</text>
    </view>
  </view>
</view> 