# 订单评价页面 API 集成说明

**状态：✅ API集成已完成**

## 更新概览

订单评价页面(`/pages/order-evaluate/index.js`)已完成静态数据向真实API的转换，严格按照接口文档(`/api-docs/order-evaluate.md`)进行字段映射。

## 主要变更

### 1. API模块创建
新建 `evaluationApi.js` 包含以下接口：
```javascript
import { 
  getOrderDetail, 
  uploadFile, 
  getEvaluationTags, 
  submitEvaluation, 
  deleteMediaFile 
} from '../../api/evaluationApi.js';
```

### 2. 页面数据结构
- 新增 `loading: true` 状态管理页面加载
- 新增 `uploading: false` 状态管理文件上传
- 新增 `submitting: false` 状态防止重复提交
- 新增 `maxSelectCount: 5` 动态控制标签选择数量
- 清空 `availableTags: []` 改为从API动态获取

### 3. 核心方法改造

#### initPageData() - 新增页面初始化
- **功能**：并行加载订单信息和评价标签
- **错误处理**：提供重试机制和友好的错误提示
- **降级策略**：标签加载失败时使用默认标签

#### loadOrderInfo() - 订单信息加载
- **接口**：`/api/evaluation/order-detail` (GET)
- **功能**：获取待评价订单详情
- **验证**：检查订单评价权限和截止时间
- **字段映射**：严格按照接口文档进行数据映射

#### loadEvaluationTags() - 评价标签获取
- **接口**：`/api/evaluation/tags` (GET)
- **功能**：根据商品类型获取可选标签
- **参数**：商品分类和类型（可选）
- **错误处理**：失败时使用默认标签，不阻断流程

#### uploadMedia() - 媒体文件上传
- **接口**：使用`uploadFile()` 调用小程序上传API
- **功能**：上传图片和视频文件
- **状态管理**：显示上传进度和状态
- **错误处理**：提供重试机制

#### deleteMedia() - 媒体文件删除
- **接口**：`/api/evaluation/delete-media` (POST)
- **功能**：删除已上传的媒体文件
- **容错处理**：服务端删除失败时仍移除本地记录

#### submitEvaluation() - 评价提交
- **接口**：`/api/evaluation/submit` (POST)
- **功能**：提交完整的商品评价
- **数据结构**：完全按照接口文档格式构建
- **防重复提交**：添加提交状态控制
- **奖励显示**：显示评价获得的积分奖励

### 4. 状态管理优化

#### 页面加载状态
- `loading: true` - 控制页面初始化加载状态
- 加载失败提供重试选项

#### 文件上传状态
- `uploading: false` - 控制文件上传状态
- 上传期间禁用相关操作

#### 提交状态管理
- `submitting: false` - 防止重复提交评价
- 提交期间显示加载状态

### 5. 标签系统优化
- 优先使用API返回的标签
- API失败时使用商品类型相关的默认标签
- 动态控制最大选择数量（从API获取）

## 接口对应关系

| 功能 | 接口地址 | 请求方式 | 状态 |
|-----|---------|---------|-----|
| 订单详情 | `/api/evaluation/order-detail` | GET | ✅ 已集成 |
| 评价标签 | `/api/evaluation/tags` | GET | ✅ 已集成 |
| 文件上传 | `/api/evaluation/upload` | POST | ✅ 已集成 |
| 删除文件 | `/api/evaluation/delete-media` | POST | ✅ 已集成 |
| 提交评价 | `/api/evaluation/submit` | POST | ✅ 已集成 |

## 错误处理策略

1. **页面初始化错误**：提供重试和返回选项
2. **订单状态错误**：检查评价权限和截止时间
3. **标签加载错误**：使用默认标签，不阻断流程
4. **文件上传错误**：提供重试机制，显示详细错误信息
5. **文件删除错误**：容错处理，确保本地状态一致
6. **评价提交错误**：提供重试机制，防止重复提交

## 用户体验优化

1. **并行加载**：订单信息和标签并行获取，提升加载速度
2. **状态反馈**：各种操作都有明确的状态提示
3. **重试机制**：关键操作失败时提供重试选项
4. **防重复操作**：文件上传和评价提交防止重复操作
5. **奖励展示**：评价成功后显示获得的积分奖励
6. **进度提示**：文件上传显示进度，评价提交显示状态

## 兼容性保证

- 保持原有页面数据结构和字段名
- 字段缺失时使用合理默认值
- 渐进式降级，API失败不完全阻断流程
- 保持与WXML模板的字段映射一致

## 数据流程

### 页面加载流程
1. 检查订单ID参数
2. 并行加载订单详情和评价标签
3. 验证订单评价权限和时效性
4. 根据商品类型调整标签（如果API标签为空）

### 评价提交流程
1. 验证必填信息（星级评分）
2. 构建评价数据对象
3. 调用提交API
4. 显示成功信息和奖励积分
5. 延时关闭页面

### 文件管理流程
1. 选择文件类型（图片/视频）
2. 调用小程序选择API
3. 上传到服务器
4. 保存文件信息到本地状态
5. 支持预览和删除操作

## 开发者注意事项

1. 所有API调用都包含详细的console.log，便于调试
2. 错误信息对用户友好，对开发者详细
3. 关键业务逻辑有严格的错误处理
4. 支持重试机制，提升用户体验
5. 遵循小程序异步编程最佳实践
6. 文件上传使用小程序原生API，兼容性更好

## 测试建议

1. 测试不同订单状态的评价权限验证
2. 测试标签API失败时的降级处理
3. 测试文件上传的各种异常情况
4. 测试网络异常时的错误处理
5. 测试重复提交评价的防护机制
6. 测试文件删除的容错处理
7. 测试评价成功后的积分奖励显示

## 性能优化

1. **并行请求**：订单详情和标签并行加载
2. **状态缓存**：避免重复的网络请求
3. **文件压缩**：图片自动压缩，减少上传时间
4. **错误恢复**：部分失败不影响整体功能
5. **内存管理**：页面卸载时清理资源 