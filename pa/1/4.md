
-- 订单操作日志表
CREATE TABLE `order_operation_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID，主键',
  `order_id` bigint NOT NULL COMMENT '订单ID，关联order_master表',
  `operation_type` tinyint NOT NULL COMMENT '操作类型：1创建订单，2支付订单，3发货，4确认收货，5取消订单，6申请退款，7退款完成',
  `operator_id` bigint DEFAULT NULL COMMENT '操作人ID',
  `operator_name` varchar(50) DEFAULT NULL COMMENT '操作人姓名',
  `operation_note` varchar(255) DEFAULT NULL COMMENT '操作备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  FOREIGN KEY (`order_id`) REFERENCES `order_master` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单操作日志表';

-- 退款申请表
CREATE TABLE `refund_application` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '退款申请ID，主键',
  `order_id` bigint NOT NULL COMMENT '订单ID，关联order_master表',
  `order_detail_id` bigint NOT NULL COMMENT '订单明细ID，关联order_detail表',
  `refund_reason` varchar(255) NOT NULL COMMENT '退款原因',
  `refund_amount` decimal(10,2) NOT NULL COMMENT '退款金额',
  `refund_status` tinyint NOT NULL DEFAULT 1 COMMENT '退款状态：1申请中，2已同意，3已拒绝，4已完成',
  `refund_type` tinyint NOT NULL COMMENT '退款类型：1仅退款，2退货退款',
  `refund_note` varchar(255) DEFAULT NULL COMMENT '退款备注',
  `refund_time` datetime DEFAULT NULL COMMENT '退款时间',
  `admin_note` varchar(255) DEFAULT NULL COMMENT '管理员备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_refund_status` (`refund_status`),
  FOREIGN KEY (`order_id`) REFERENCES `order_master` (`id`),
  FOREIGN KEY (`order_detail_id`) REFERENCES `order_detail` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='退款申请表';

-- ----------------------------
-- 促销相关表
-- ----------------------------

-- 优惠券表
CREATE TABLE `coupon` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '优惠券ID，主键',
  `coupon_name` varchar(100) NOT NULL COMMENT '优惠券名称',
  `coupon_type` tinyint NOT NULL COMMENT '优惠券类型：1满减券，2折扣券，3无门槛券',
  `amount` decimal(10,2) NOT NULL COMMENT '优惠金额/折扣率',
  `min_amount` decimal(10,2) DEFAULT 0.00 COMMENT '最低消费金额',
  `total_count` int DEFAULT NULL COMMENT '总发行量，null表示无限',
  `received_count` int DEFAULT 0 COMMENT '已领取数量',
  `used_count` int DEFAULT 0 COMMENT '已使用数量',
  `valid_type` tinyint NOT NULL COMMENT '有效期类型：1固定时间，2领取后N天有效',
  `start_time` datetime DEFAULT NULL COMMENT '开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '结束时间',
  `valid_days` int DEFAULT NULL COMMENT '有效天数',
  `status` tinyint DEFAULT 1 COMMENT '状态：0禁用，1启用',
  `applicable_type` tinyint DEFAULT 1 COMMENT '适用类型：1全场通用，2指定分类，3指定商品',
  `applicable_value` varchar(255) DEFAULT NULL COMMENT '适用值，JSON格式，存储分类ID或商品ID列表',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券表';

-- 用户优惠券表
CREATE TABLE `user_coupon` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户优惠券ID，主键',
  `user_id` bigint NOT NULL COMMENT '用户ID，关联user表',
  `coupon_id` bigint NOT NULL COMMENT '优惠券ID，关联coupon表',
  `coupon_code` varchar(50) NOT NULL COMMENT '优惠券码',
  `status` tinyint NOT NULL DEFAULT 1 COMMENT '状态：1未使用，2已使用，3已过期',
  `use_time` datetime DEFAULT NULL COMMENT '使用时间',
  `order_id` bigint DEFAULT NULL COMMENT '订单ID，关联order_master表',
  `obtain_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '领取时间',
  `expire_time` datetime NOT NULL COMMENT '过期时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_coupon_code` (`coupon_code`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_coupon_id` (`coupon_id`),
  KEY `idx_status` (`status`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  FOREIGN KEY (`coupon_id`) REFERENCES `coupon` (`id`),
  FOREIGN KEY (`order_id`) REFERENCES `order_master` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户优惠券表';

-- 限时折扣活动表
CREATE TABLE `flash_sale` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '活动ID，主键',
  `activity_name` varchar(100) NOT NULL COMMENT '活动名称',
  `start_time` datetime NOT NULL COMMENT '开始时间',
  `end_time` datetime NOT NULL COMMENT '结束时间',
  `status` tinyint DEFAULT 1 COMMENT '状态：0禁用，1启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='限时折扣活动表';