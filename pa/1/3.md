
-- 商品SKU表
CREATE TABLE `product_sku` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'SKU ID，主键',
  `product_id` bigint NOT NULL COMMENT '商品ID，关联product表',
  `sku_code` varchar(100) DEFAULT NULL COMMENT 'SKU编码',
  `market_price` decimal(10,2) DEFAULT NULL COMMENT '市场价格',
  `sale_price` decimal(10,2) NOT NULL COMMENT '销售价格',
  `cost_price` decimal(10,2) DEFAULT NULL COMMENT '成本价格',
  `stock` int DEFAULT 0 COMMENT '库存数量',
  `weight` decimal(10,2) DEFAULT NULL COMMENT '重量（kg）',
  `barcode` varchar(100) DEFAULT NULL COMMENT '条形码',
  `attr_values` varchar(255) DEFAULT NULL COMMENT '属性值JSON字符串，格式：[{"attr_id":1,"attr_value":"黑色"},{"attr_id":2,"attr_value":"16G"}]',
  `status` tinyint DEFAULT 1 COMMENT '状态：0禁用，1启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_sku_code` (`sku_code`),
  KEY `idx_product_id` (`product_id`),
  FOREIGN KEY (`product_id`) REFERENCES `product` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品SKU表';

-- 商品库存记录表
CREATE TABLE `product_stock_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '记录ID，主键',
  `product_id` bigint NOT NULL COMMENT '商品ID，关联product表',
  `sku_id` bigint DEFAULT NULL COMMENT 'SKU ID，关联product_sku表',
  `original_stock` int NOT NULL COMMENT '原库存',
  `current_stock` int NOT NULL COMMENT '现库存',
  `change_quantity` int NOT NULL COMMENT '变化数量',
  `change_reason` varchar(255) DEFAULT NULL COMMENT '变化原因',
  `operator_id` bigint DEFAULT NULL COMMENT '操作人ID',
  `operator_name` varchar(50) DEFAULT NULL COMMENT '操作人姓名',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_sku_id` (`sku_id`),
  KEY `idx_create_time` (`create_time`),
  FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品库存记录表';

-- ----------------------------
-- 购物车相关表
-- ----------------------------

-- 购物车表
CREATE TABLE `shopping_cart` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '购物车ID，主键',
  `user_id` bigint NOT NULL COMMENT '用户ID，关联user表',
  `product_id` bigint NOT NULL COMMENT '商品ID，关联product表',
  `sku_id` bigint DEFAULT NULL COMMENT 'SKU ID，关联product_sku表',
  `quantity` int NOT NULL DEFAULT 1 COMMENT '购买数量',
  `selected` tinyint DEFAULT 1 COMMENT '是否选中：0否，1是',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_user_product_sku` (`user_id`,`product_id`,`sku_id`),
  KEY `idx_user_id` (`user_id`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='购物车表';

-- ----------------------------
-- 订单相关表
-- ----------------------------

-- 订单主表
CREATE TABLE `order_master` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '订单ID，主键',
  `order_sn` varchar(50) NOT NULL COMMENT '订单编号',
  `user_id` bigint NOT NULL COMMENT '用户ID，关联user表',
  `order_status` tinyint NOT NULL DEFAULT 1 COMMENT '订单状态：1待支付，2已支付，3待发货，4已发货，5已完成，6已取消，7已退款',
  `payment_type` tinyint DEFAULT NULL COMMENT '支付方式：1微信支付，2支付宝，3货到付款',
  `payment_time` datetime DEFAULT NULL COMMENT '支付时间',
  `shipping_time` datetime DEFAULT NULL COMMENT '发货时间',
  `receive_time` datetime DEFAULT NULL COMMENT '收货时间',
  `close_time` datetime DEFAULT NULL COMMENT '关闭时间',
  `total_amount` decimal(10,2) NOT NULL COMMENT '订单总金额',
  `discount_amount` decimal(10,2) DEFAULT 0.00 COMMENT '优惠金额',
  `shipping_amount` decimal(10,2) DEFAULT 0.00 COMMENT '运费金额',
  `actual_amount` decimal(10,2) NOT NULL COMMENT '实际支付金额',
  `consignee` varchar(50) NOT NULL COMMENT '收货人姓名',
  `phone` varchar(20) NOT NULL COMMENT '收货人手机号',
  `country` varchar(50) DEFAULT NULL COMMENT '国家',
  `province` varchar(50) NOT NULL COMMENT '省份',
  `coupon_id` bigint DEFAULT NULL COMMENT '优惠券ID',
  `city` varchar(50) NOT NULL COMMENT '城市',
  `district` varchar(50) NOT NULL COMMENT '区县',
  `address` varchar(255) NOT NULL COMMENT '详细地址',
  `zip_code` varchar(20) DEFAULT NULL COMMENT '邮政编码',
  `shipping_company` varchar(50) DEFAULT NULL COMMENT '物流公司',
  `shipping_number` varchar(100) DEFAULT NULL COMMENT '物流单号',
  `user_note` varchar(255) DEFAULT NULL COMMENT '用户备注',
  `admin_note` varchar(255) DEFAULT NULL COMMENT '管理员备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_order_sn` (`order_sn`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_order_status` (`order_status`),
  KEY `idx_create_time` (`create_time`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单主表';

-- 订单商品明细表
CREATE TABLE `order_detail` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '明细ID，主键',
  `order_id` bigint NOT NULL COMMENT '订单ID，关联order_master表',
  `product_id` bigint NOT NULL COMMENT '商品ID，关联product表',
  `product_name` varchar(200) NOT NULL COMMENT '商品名称',
  `product_image` varchar(255) DEFAULT NULL COMMENT '商品图片',
  `sku_id` bigint DEFAULT NULL COMMENT 'SKU ID，关联product_sku表',
  `attr_values` varchar(255) DEFAULT NULL COMMENT '属性值JSON字符串',
  `quantity` int NOT NULL COMMENT '购买数量',
  `price` decimal(10,2) NOT NULL COMMENT '商品单价',
  `total_price` decimal(10,2) NOT NULL COMMENT '商品总价',
  `status` tinyint DEFAULT 1 COMMENT '状态：1正常，2退货中，3已退货',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_product_id` (`product_id`),
  FOREIGN KEY (`order_id`) REFERENCES `order_master` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单商品明细表';